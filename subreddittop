#!/usr/bin/env ruby

require 'json'
require 'nokogiri'
require 'open-uri'
require 'pathname'
require 'rss'

# Required environment variables
Feed_local_dir = Pathname(ENV['FEED_LOCAL_DIR']) rescue nil
Feed_web_dir = Pathname(ENV['FEED_WEB_DIR']) rescue nil
Feed_settings_dir = Pathname(ENV['FEED_SETTINGS_DIR']) rescue nil

unless Feed_local_dir&.directory? && Feed_local_dir&.writable?
  abort <<~ERROR
    Missing a "FEED_LOCAL_DIR" environment variable pointing to a writable directory
  ERROR
end

unless Feed_web_dir
  abort <<~ERROR
    Missing a "FEED_WEB_DIR" environment variable
    pointing to the web directory path where the feed will be accessible from
  ERROR
end

unless Feed_settings_dir&.directory? && Feed_settings_dir&.writable?
  abort <<~ERROR
    Missing a "FEED_SETTINGS_DIR" environment variable
    pointing to a directory where the config file for this script must reside
  ERROR
end

# Configure feed info
site_url = 'https://reddit.com/'
feed_title = 'Subreddit top post amalgamation'
feed_name = 'subreddittop'

feed_file = Feed_local_dir.join("#{feed_name}.json")
feed_location = Feed_web_dir.join("#{feed_name}.json")

feed = {
  version: 'https://jsonfeed.org/version/1',
  title: feed_title,
  home_page_url: site_url,
  feed_url: feed_location
}

# Leave as is. Preparing the feed.
feed_new = {}
feed_new['items'] = []
feed_old = JSON.parse(feed_file.read) rescue { 'items' => [] }
# DIFFERENT CASE FROM OTHER FEED SCRIPTS, DOES NOT NEED feed_old_first_url

# Strategy for getting new items
Config_file = Feed_settings_dir.join('subreddits.txt')
abort "Missing #{Config_file}" unless Config_file.file?

check_period = 'week'
subreddits = Config_file.read.split("\n")

subreddits.each do |subreddit|
  site_url = 'https://www.reddit.com/r/' + subreddit + '/top.rss?t=' + check_period + '&limit=1'

  top_item = RSS::Parser.parse(URI.parse(site_url).open('User-Agent' => 'Mozilla/5.0 (X11; Linux x86_64)')).items.first
  item_url = top_item.link.href
  item_title = top_item.title.content

  feed_new['items'].push(title: item_title, id: item_url, url: item_url, content_html: 'From r/' + subreddit )
end

# If there are no new items, inform and exit
if feed_new['items'].empty?
  puts 'There are no new items to add'
  exit 0
end

# Prepend new items to the old and limit the amount of items
feed['items'] = (feed_new['items'] + feed_old['items']).first(100)

feed_file.write(JSON.pretty_generate(feed))
